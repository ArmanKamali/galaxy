{"version":3,"sources":["mvc/history/history-view-edit.js"],"names":["_super","_historyView2","default","HistoryView","HistoryViewEdit","extend","HDAViewClass","_hdaLiEdit2","HDAListItemEdit","HDCAViewClass","_hdcaLiEdit2","HDCAListItemEdit","initialize","attributes","prototype","call","this","tagsEditor","dragItems","annotationEditor","purgeAllowed","annotationEditorShown","_setUpListeners","on","ev","data","dataDropped","dropTargetOff","view:attached view:removed","_renderCounts","search:loading-progress","_renderSearchProgress","search:searching","_renderSearchFindings","_setUpModelListeners","listenTo","model","updateHistoryDiskSize","_setUpCollectionListeners","change:deleted","_handleItemDeletedChange","change:visible","_handleItemVisibleChange","change:purged","fetching-deleted","collection","$","html","_localization2","fetching-hidden","fetching-deleted-done fetching-hidden-done","_buildNewRender","$newRender","Galaxy","user","id","get","_renderTags","_renderAnnotation","text","renderItems","$whereTo","views","searchFor","jQuery","$el","counts","toJSON","$where","panel","_tag2","TagsEditor","el","find","onshowFirstTime","render","fxSpeed","onhide","$activator","_faIconButton2","title","classes","faIcon","_annotation2","AnnotationEditor","onshow","toggleHDAAnnotationEditors","toggleHDATagEditors","isAnonymous","appendTo","newName","previousName","save","name","fail","previous","multiselectActions","nameSelector","on_finish","func","hide","action","_hdaModel2","HistoryDatasetAssociation","unhide","getSelectedModels","ajaxQueue","confirm","purge","historyContents","filter","c","selectedDatasets","actions","concat","_collectionActions","buildCollection","collectionType","selection","hideSourceItems","createFunc","_listCollectionCreator2","createListCollection","createPairCollection","_listOfPairsCollectionCreator2","createListOfPairsCollection","console","warn","done","options","_getItemViewOptions","hidden","itemModel","tagsEditorShown","_handleItemDeletion","contentsShown","deleted","active","includeDeleted","set","_handleItemUndeletion","_handleItemUnhidden","_handleItemHidden","includeHidden","contents","showOrHide","_","each","view","toggle","speed","events","clone","click .show-selectors-btn","click .toggle-deleted-link","click .toggle-hidden-link","limit","offset","stop","join","toggleShowHidden","templates","found","dropTargetOn","dropTarget","dropHandlers","dragenter","bind","dragover","dragleave","drop","$dropTarget","_renderDropTarget","_renderDropTargetHelp","evName","hasOwnProperty","before","remove","addClass","_dropHandlers","off","dropTargetToggle","preventDefault","stopPropagation","css","originalEvent","dataTransfer","getData","dropEffect","err","self","isObject","model_class","trigger","currentPage","fetchPage","then","copy","when","toString","countsTemplate","_baseMvc2","wrapTemplate","foundTemplate"],"mappings":"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","file":"../../../scripts/mvc/history/history-view-edit.js","sourcesContent":["import HISTORY_VIEW from \"mvc/history/history-view\";\nimport HISTORY_CONTENTS from \"mvc/history/history-contents\";\nimport STATES from \"mvc/dataset/states\";\nimport HDA_MODEL from \"mvc/history/hda-model\";\nimport HDA_LI_EDIT from \"mvc/history/hda-li-edit\";\nimport HDCA_LI_EDIT from \"mvc/history/hdca-li-edit\";\nimport TAGS from \"mvc/tag\";\nimport ANNOTATIONS from \"mvc/annotation\";\nimport LIST_COLLECTION_CREATOR from \"mvc/collection/list-collection-creator\";\nimport PAIR_COLLECTION_CREATOR from \"mvc/collection/pair-collection-creator\";\nimport LIST_OF_PAIRS_COLLECTION_CREATOR from \"mvc/collection/list-of-pairs-collection-creator\";\nimport faIconButton from \"ui/fa-icon-button\";\nimport PopupMenu from \"mvc/ui/popup-menu\";\nimport BASE_MVC from \"mvc/base-mvc\";\nimport _l from \"utils/localization\";\nimport \"ui/editable-text\";\n\n/* =============================================================================\nTODO:\n\n============================================================================= */\nvar _super = HISTORY_VIEW.HistoryView;\n// base class for history-view-edit-current and used as-is in history/view.mako\n/** @class Editable View/Controller for the history model.\n *\n *  Allows:\n *      (everything HistoryView allows)\n *      changing the name\n *      displaying and editing tags and annotations\n *      multi-selection and operations on mulitple content items\n */\nvar HistoryViewEdit = _super.extend(\n    /** @lends HistoryViewEdit.prototype */ {\n        /** class to use for constructing the HistoryDatasetAssociation views */\n        HDAViewClass: HDA_LI_EDIT.HDAListItemEdit,\n        /** class to use for constructing the HistoryDatasetCollectionAssociation views */\n        HDCAViewClass: HDCA_LI_EDIT.HDCAListItemEdit,\n\n        // ......................................................................... SET UP\n        /** Set up the view, set up storage, bind listeners to HistoryContents events\n         *  @param {Object} attributes\n         */\n        initialize: function(attributes) {\n            attributes = attributes || {};\n            _super.prototype.initialize.call(this, attributes);\n\n            // ---- set up instance vars\n            /** editor for tags - sub-view */\n            this.tagsEditor = null;\n\n            /** enable drag and drop - sub-view */\n            this.dragItems = true;\n\n            /** editor for annotations - sub-view */\n            this.annotationEditor = null;\n\n            /** allow user purge of dataset files? */\n            this.purgeAllowed = attributes.purgeAllowed || false;\n\n            // states/modes the panel can be in\n            /** is the panel currently showing the dataset selection controls? */\n            this.annotationEditorShown = attributes.annotationEditorShown || false;\n            this.tagsEditorShown = attributes.tagsEditorShown || false;\n        },\n\n        /** Override to handle history as drag-drop target */\n        _setUpListeners: function() {\n            _super.prototype._setUpListeners.call(this);\n            return this.on({\n                \"droptarget:drop\": function(ev, data) {\n                    // process whatever was dropped and re-hide the drop target\n                    this.dataDropped(data);\n                    this.dropTargetOff();\n                },\n                \"view:attached view:removed\": function() {\n                    this._renderCounts();\n                },\n                \"search:loading-progress\": this._renderSearchProgress,\n                \"search:searching\": this._renderSearchFindings\n            });\n        },\n\n        // ------------------------------------------------------------------------ listeners\n        /** listening for history and HDA events */\n        _setUpModelListeners: function() {\n            _super.prototype._setUpModelListeners.call(this);\n            this.listenTo(this.model, \"change:size\", this.updateHistoryDiskSize);\n            return this;\n        },\n\n        /** listening for collection events */\n        _setUpCollectionListeners: function() {\n            _super.prototype._setUpCollectionListeners.call(this);\n            this.listenTo(this.collection, {\n                \"change:deleted\": this._handleItemDeletedChange,\n                \"change:visible\": this._handleItemVisibleChange,\n                \"change:purged\": function(model) {\n                    // hafta get the new nice-size w/o the purged model\n                    this.model.fetch();\n                },\n                // loading indicators for deleted/hidden\n                \"fetching-deleted\": function(collection) {\n                    this.$(\"> .controls .deleted-count\").html(`<i>${_l(\"loading...\")}</i>`);\n                },\n                \"fetching-hidden\": function(collection) {\n                    this.$(\"> .controls .hidden-count\").html(`<i>${_l(\"loading...\")}</i>`);\n                },\n                \"fetching-deleted-done fetching-hidden-done\": this._renderCounts\n            });\n            return this;\n        },\n\n        // ------------------------------------------------------------------------ panel rendering\n        /** In this override, add tag and annotation editors and a btn to toggle the selectors */\n        _buildNewRender: function() {\n            // create a new render using a skeleton template, render title buttons, render body, and set up events, etc.\n            var $newRender = _super.prototype._buildNewRender.call(this);\n            if (!this.model) {\n                return $newRender;\n            }\n\n            if (Galaxy && Galaxy.user && Galaxy.user.id && Galaxy.user.id === this.model.get(\"user_id\")) {\n                this._renderTags($newRender);\n                this._renderAnnotation($newRender);\n            }\n            return $newRender;\n        },\n\n        /** Update the history size display (curr. upper right of panel). */\n        updateHistoryDiskSize: function() {\n            this.$(\".history-size\").text(this.model.get(\"nice_size\"));\n        },\n\n        /** override to render counts when the items are rendered */\n        renderItems: function($whereTo) {\n            var views = _super.prototype.renderItems.call(this, $whereTo);\n            if (!this.searchFor) {\n                this._renderCounts($whereTo);\n            } else {\n                this._renderSearchFindings($whereTo);\n            }\n            return views;\n        },\n\n        /** override to show counts, what's deleted/hidden, and links to toggle those */\n        _renderCounts: function($whereTo) {\n            $whereTo = $whereTo instanceof jQuery ? $whereTo : this.$el;\n            var html = this.templates.counts(this.model.toJSON(), this);\n            return $whereTo.find(\"> .controls .subtitle\").html(html);\n        },\n\n        /** render the tags sub-view controller */\n        _renderTags: function($where) {\n            var panel = this;\n            this.tagsEditor = new TAGS.TagsEditor({\n                model: this.model,\n                el: $where.find(\".controls .tags-display\"),\n                onshowFirstTime: function() {\n                    this.render();\n                },\n                // show hide sub-view tag editors when this is shown/hidden\n                onshow: function() {\n                    panel.toggleHDATagEditors(true, panel.fxSpeed);\n                },\n                onhide: function() {\n                    panel.toggleHDATagEditors(false, panel.fxSpeed);\n                },\n                $activator: faIconButton({\n                    title: _l(\"Edit history tags\"),\n                    classes: \"history-tag-btn\",\n                    faIcon: \"fa-tags\"\n                }).appendTo($where.find(\".controls .actions\"))\n            });\n        },\n        /** render the annotation sub-view controller */\n        _renderAnnotation: function($where) {\n            var panel = this;\n            this.annotationEditor = new ANNOTATIONS.AnnotationEditor({\n                model: this.model,\n                el: $where.find(\".controls .annotation-display\"),\n                onshowFirstTime: function() {\n                    this.render();\n                },\n                // show hide sub-view view annotation editors when this is shown/hidden\n                onshow: function() {\n                    panel.toggleHDAAnnotationEditors(true, panel.fxSpeed);\n                },\n                onhide: function() {\n                    panel.toggleHDAAnnotationEditors(false, panel.fxSpeed);\n                },\n                $activator: faIconButton({\n                    title: _l(\"Edit history annotation\"),\n                    classes: \"history-annotate-btn\",\n                    faIcon: \"fa-comment\"\n                }).appendTo($where.find(\".controls .actions\"))\n            });\n        },\n\n        /** Set up HistoryViewEdit js/widget behaviours\n         *  In this override, make the name editable\n         */\n        _setUpBehaviors: function($where) {\n            $where = $where || this.$el;\n            _super.prototype._setUpBehaviors.call(this, $where);\n            if (!this.model) {\n                return;\n            }\n\n            // anon users shouldn't have access to any of the following\n            if (!Galaxy.user || Galaxy.user.isAnonymous() || Galaxy.user.id !== this.model.get(\"user_id\")) {\n                return;\n            }\n\n            var panel = this;\n            var nameSelector = \"> .controls .name\";\n            $where\n                .find(nameSelector)\n                .attr(\"title\", _l(\"Click to rename history\"))\n                .tooltip({ placement: \"bottom\" })\n                .make_text_editable({\n                    on_finish: function(newName) {\n                        var previousName = panel.model.get(\"name\");\n                        if (newName && newName !== previousName) {\n                            panel.$el.find(nameSelector).text(newName);\n                            panel.model.save({ name: newName }).fail(() => {\n                                panel.$el.find(nameSelector).text(panel.model.previous(\"name\"));\n                            });\n                        } else {\n                            panel.$el.find(nameSelector).text(previousName);\n                        }\n                    }\n                });\n        },\n\n        /** return a new popup menu for choosing a multi selection action\n         *  ajax calls made for multiple datasets are queued\n         */\n        multiselectActions: function() {\n            var panel = this;\n\n            var actions = [\n                {\n                    html: _l(\"Hide datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.hide;\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                },\n                {\n                    html: _l(\"Unhide datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.unhide;\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                },\n                {\n                    html: _l(\"Delete datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype[\"delete\"];\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                },\n                {\n                    html: _l(\"Undelete datasets\"),\n                    func: function() {\n                        var action = HDA_MODEL.HistoryDatasetAssociation.prototype.undelete;\n                        panel.getSelectedModels().ajaxQueue(action);\n                    }\n                }\n            ];\n\n            if (panel.purgeAllowed) {\n                actions.push({\n                    html: _l(\"Permanently delete datasets\"),\n                    func: function() {\n                        if (confirm(_l(\"This will permanently remove the data in your datasets. Are you sure?\"))) {\n                            var action = HDA_MODEL.HistoryDatasetAssociation.prototype.purge;\n                            const historyContents = panel.getSelectedModels();\n                            const selectedDatasets = historyContents.filter(\n                                c =>\n                                    c.get(\"history_content_type\") == \"dataset\"\n                            )\n                            historyContents.ajaxQueue(action, {}, selectedDatasets);\n                        }\n                    }\n                });\n            }\n            actions = actions.concat(panel._collectionActions());\n            return actions;\n        },\n\n        /**   */\n        _collectionActions: function() {\n            var panel = this;\n            return [\n                {\n                    html: _l(\"Build Dataset List\"),\n                    func: function() {\n                        panel.buildCollection(\"list\");\n                    }\n                },\n                // TODO: Only show quick pair if two things selected.\n                {\n                    html: _l(\"Build Dataset Pair\"),\n                    func: function() {\n                        panel.buildCollection(\"paired\");\n                    }\n                },\n                {\n                    html: _l(\"Build List of Dataset Pairs\"),\n                    func: function() {\n                        panel.buildCollection(\"list:paired\");\n                    }\n                }\n            ];\n        },\n\n        buildCollection: function(collectionType, selection, hideSourceItems) {\n            var panel = this;\n            var selection = selection || panel.getSelectedModels();\n            var hideSourceItems = hideSourceItems || false;\n            var createFunc;\n            if (collectionType == \"list\") {\n                createFunc = LIST_COLLECTION_CREATOR.createListCollection;\n            } else if (collectionType == \"paired\") {\n                createFunc = PAIR_COLLECTION_CREATOR.createPairCollection;\n            } else if (collectionType == \"list:paired\") {\n                createFunc = LIST_OF_PAIRS_COLLECTION_CREATOR.createListOfPairsCollection;\n            } else {\n                console.warn(`Unknown collectionType encountered ${collectionType}`);\n            }\n            createFunc(selection, hideSourceItems).done(() => {\n                panel.model.refresh();\n            });\n        },\n\n        // ------------------------------------------------------------------------ sub-views\n        /** In this override, add purgeAllowed and whether tags/annotation editors should be shown */\n        _getItemViewOptions: function(model) {\n            var options = _super.prototype._getItemViewOptions.call(this, model);\n            _.extend(options, {\n                purgeAllowed: this.purgeAllowed,\n                tagsEditorShown: this.tagsEditor && !this.tagsEditor.hidden,\n                annotationEditorShown: this.annotationEditor && !this.annotationEditor.hidden\n            });\n            return options;\n        },\n\n        /** If this item is deleted and we're not showing deleted items, remove the view\n         *  @param {Model} the item model to check\n         */\n        _handleItemDeletedChange: function(itemModel) {\n            if (itemModel.get(\"deleted\")) {\n                this._handleItemDeletion(itemModel);\n            } else {\n                this._handleItemUndeletion(itemModel);\n            }\n            this._renderCounts();\n        },\n\n        _handleItemDeletion: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.deleted += 1;\n            contentsShown.active -= 1;\n            if (!this.model.contents.includeDeleted) {\n                this.removeItemView(itemModel);\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        _handleItemUndeletion: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.deleted -= 1;\n            if (!this.model.contents.includeDeleted) {\n                contentsShown.active -= 1;\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        /** If this item is hidden and we're not showing hidden items, remove the view\n         *  @param {Model} the item model to check\n         */\n        _handleItemVisibleChange: function(itemModel) {\n            if (itemModel.hidden()) {\n                this._handleItemHidden(itemModel);\n            } else {\n                this._handleItemUnhidden(itemModel);\n            }\n            this._renderCounts();\n        },\n\n        _handleItemHidden: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.hidden += 1;\n            contentsShown.active -= 1;\n            if (!this.model.contents.includeHidden) {\n                this.removeItemView(itemModel);\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        _handleItemUnhidden: function(itemModel) {\n            var contentsShown = this.model.get(\"contents_active\");\n            contentsShown.hidden -= 1;\n            if (!this.model.contents.includeHidden) {\n                contentsShown.active -= 1;\n            }\n            this.model.set(\"contents_active\", contentsShown);\n        },\n\n        /** toggle the visibility of each content's tagsEditor applying all the args sent to this function */\n        toggleHDATagEditors: function(showOrHide, speed) {\n            _.each(this.views, view => {\n                if (view.tagsEditor) {\n                    view.tagsEditor.toggle(showOrHide, speed);\n                }\n            });\n        },\n\n        /** toggle the visibility of each content's annotationEditor applying all the args sent to this function */\n        toggleHDAAnnotationEditors: function(showOrHide, speed) {\n            _.each(this.views, view => {\n                if (view.annotationEditor) {\n                    view.annotationEditor.toggle(showOrHide, speed);\n                }\n            });\n        },\n\n        // ------------------------------------------------------------------------ panel events\n        /** event map */\n        events: _.extend(_.clone(_super.prototype.events), {\n            \"click .show-selectors-btn\": \"toggleSelectors\",\n            \"click .toggle-deleted-link\": function(ev) {\n                this.toggleShowDeleted();\n            },\n            \"click .toggle-hidden-link\": function(ev) {\n                this.toggleShowHidden();\n            }\n        }),\n\n        // ------------------------------------------------------------------------ search\n        _renderSearchProgress: function(limit, offset) {\n            var stop = limit + offset;\n            return this.$(\"> .controls .subtitle\").html(\n                [\"<i>\", _l(\"Searching \"), stop, \"/\", this.model.contentsShown(), \"</i>\"].join(\"\")\n            );\n        },\n\n        /** override to display number found in subtitle */\n        _renderSearchFindings: function($whereTo) {\n            $whereTo = $whereTo instanceof jQuery ? $whereTo : this.$el;\n            var html = this.templates.found(this.model.toJSON(), this);\n            $whereTo.find(\"> .controls .subtitle\").html(html);\n            return this;\n        },\n\n        // ------------------------------------------------------------------------ as drop target\n        /** turn all the drag and drop handlers on and add some help text above the drop area */\n        dropTargetOn: function() {\n            if (this.dropTarget) {\n                return this;\n            }\n            this.dropTarget = true;\n\n            //TODO: to init\n            var dropHandlers = {\n                dragenter: _.bind(this.dragenter, this),\n                dragover: _.bind(this.dragover, this),\n                dragleave: _.bind(this.dragleave, this),\n                drop: _.bind(this.drop, this)\n            };\n\n            var $dropTarget = this._renderDropTarget();\n            this.$list().before([this._renderDropTargetHelp(), $dropTarget]);\n            for (var evName in dropHandlers) {\n                if (dropHandlers.hasOwnProperty(evName)) {\n                    //console.debug( evName, dropHandlers[ evName ] );\n                    $dropTarget.on(evName, dropHandlers[evName]);\n                }\n            }\n            return this;\n        },\n\n        /** render a box to serve as a 'drop here' area on the history */\n        _renderDropTarget: function() {\n            this.$(\".history-drop-target\").remove();\n            return $(\"<div/>\").addClass(\"history-drop-target\");\n        },\n\n        /** tell the user how it works  */\n        _renderDropTargetHelp: function() {\n            this.$(\".history-drop-target-help\").remove();\n            return $(\"<div/>\")\n                .addClass(\"history-drop-target-help\")\n                .text(_l(\"Drag datasets here to copy them to the current history\"));\n        },\n\n        /** shut down drag and drop event handlers and remove drop target */\n        dropTargetOff: function() {\n            if (!this.dropTarget) {\n                return this;\n            }\n            //this.log( 'dropTargetOff' );\n            this.dropTarget = false;\n            var dropTarget = this.$(\".history-drop-target\").get(0);\n            for (var evName in this._dropHandlers) {\n                if (this._dropHandlers.hasOwnProperty(evName)) {\n                    dropTarget.off(evName, this._dropHandlers[evName]);\n                }\n            }\n            this.$(\".history-drop-target\").remove();\n            this.$(\".history-drop-target-help\").remove();\n            return this;\n        },\n        /** toggle the target on/off */\n        dropTargetToggle: function() {\n            if (this.dropTarget) {\n                this.dropTargetOff();\n            } else {\n                this.dropTargetOn();\n            }\n            return this;\n        },\n\n        dragenter: function(ev) {\n            //console.debug( 'dragenter:', this, ev );\n            ev.preventDefault();\n            ev.stopPropagation();\n            this.$(\".history-drop-target\").css(\"border\", \"2px solid black\");\n        },\n        dragover: function(ev) {\n            ev.preventDefault();\n            ev.stopPropagation();\n        },\n        dragleave: function(ev) {\n            //console.debug( 'dragleave:', this, ev );\n            ev.preventDefault();\n            ev.stopPropagation();\n            this.$(\".history-drop-target\").css(\"border\", \"1px dashed black\");\n        },\n        /** when (text) is dropped try to parse as json and trigger an event */\n        drop: function(ev) {\n            ev.preventDefault();\n            //ev.stopPropagation();\n\n            var self = this;\n            var dataTransfer = ev.originalEvent.dataTransfer;\n            var data = dataTransfer.getData(\"text\");\n\n            dataTransfer.dropEffect = \"move\";\n            try {\n                data = JSON.parse(data);\n            } catch (err) {\n                self.warn(\"error parsing JSON from drop:\", data);\n            }\n\n            self.trigger(\"droptarget:drop\", ev, data, self);\n            return false;\n        },\n\n        /** handler that copies data into the contents */\n        dataDropped: function(data) {\n            var self = this;\n            // HDA: dropping will copy it to the history\n            if (_.isObject(data) && data.model_class === \"HistoryDatasetAssociation\" && data.id) {\n                if (self.contents.currentPage !== 0) {\n                    return self.contents.fetchPage(0).then(() => self.model.contents.copy(data.id));\n                }\n                return self.model.contents.copy(data.id);\n            }\n            return jQuery.when();\n        },\n\n        // ........................................................................ misc\n        /** Return a string rep of the history */\n        toString: function() {\n            return `HistoryViewEdit(${this.model ? this.model.get(\"name\") : \"\"})`;\n        }\n    }\n);\n\n//------------------------------------------------------------------------------ TEMPLATES\nHistoryViewEdit.prototype.templates = (() => {\n    var countsTemplate = BASE_MVC.wrapTemplate(\n        [\n            \"<% var shown = Math.max( view.views.length, history.contents_active.active ) %>\",\n            \"<% if( shown ){ %>\",\n            '<span class=\"shown-count\">',\n            \"<%- shown %> \",\n            _l(\"shown\"),\n            \"</span>\",\n            \"<% } %>\",\n\n            \"<% if( history.contents_active.deleted ){ %>\",\n            '<span class=\"deleted-count\">',\n            \"<% if( view.model.contents.includeDeleted ){ %>\",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"hide deleted\"),\n            \"</a>\",\n            \"<% } else { %>\",\n            \"<%- history.contents_active.deleted %> \",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"deleted\"),\n            \"</a>\",\n            \"<% } %>\",\n            \"</span>\",\n            \"<% } %>\",\n\n            \"<% if( history.contents_active.hidden ){ %>\",\n            '<span class=\"hidden-count\">',\n            \"<% if( view.model.contents.includeHidden ){ %>\",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"hide hidden\"),\n            \"</a>\",\n            \"<% } else { %>\",\n            \"<%- history.contents_active.hidden %> \",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"hidden\"),\n            \"</a>\",\n            \"<% } %>\",\n            \"</span>\",\n            \"<% } %>\"\n        ],\n        \"history\"\n    );\n\n    var foundTemplate = BASE_MVC.wrapTemplate(\n        [\n            _l(\"Found\"),\n            \" <%- view.views.length %>, \",\n\n            \"<% if( history.contents_active.deleted ){ %>\",\n            \"<% if( view.model.contents.includeDeleted ){ %>\",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"hide deleted\"),\n            \"</a>, \",\n            \"<% } else { %>\",\n            '<a class=\"toggle-deleted-link\" href=\"javascript:void(0);\">',\n            _l(\"show deleted\"),\n            \"</a>, \",\n            \"<% } %>\",\n            \"<% } %>\",\n\n            \"<% if( history.contents_active.hidden ){ %>\",\n            \"<% if( view.model.contents.includeHidden ){ %>\",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"hide hidden\"),\n            \"</a>\",\n            \"<% } else { %>\",\n            '<a class=\"toggle-hidden-link\" href=\"javascript:void(0);\">',\n            _l(\"show hidden\"),\n            \"</a>\",\n            \"<% } %>\",\n            \"<% } %>\"\n        ],\n        \"history\"\n    );\n\n    return _.extend(_.clone(_super.prototype.templates), {\n        counts: countsTemplate,\n        found: foundTemplate\n    });\n})();\n\n//==============================================================================\nexport default {\n    HistoryViewEdit: HistoryViewEdit\n};\n"]}